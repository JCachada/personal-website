{"componentChunkName":"component---src-templates-blog-post-js","path":"/game-update-august-2020/","result":{"data":{"site":{"siteMetadata":{"title":"J. Cachada Personal Website"}},"markdownRemark":{"id":"db58a78c-cf2a-5a76-bf03-cc9f5f092d1f","excerpt":"As I’m still deep in working on my book to meet my goal of having it ready this year, I didn’t make any progress on the game this month. I will therefore spend…","html":"<p>As I’m still deep in working on my book to meet my goal of having it ready this year, I didn’t make any progress on the game this month. I will therefore spend some time explaining how I implemented a rudimentary save / load game system in the game, as that’s a central part of any gaming experience. </p>\n<h2>The problem</h2>\n<p>Players make progress when playing a game - they discover new locations, get new items, gain XP and stats, and talk to new people. All of these changes, to a varying degree, must be persisted between play sessions. The player must not lose any progress if he turns off the game and then turns it back on again; this would make finishing the game very hard as soon as it had any degree of complexity, and it would demotivate players from investing time into it. </p>\n<p>The problem is especially true in a story driven game where your choices impact the plot: those choices cannot be lost, as they’re central to the narrative that you’re going to experience. So, how do you go about implementing a save game system? I decided to give it a go myself, as with most things in the game, to see if I could figure it out.</p>\n<h2>Breaking down the problem</h2>\n<p>The first thing I did was attempt to break down the problem. What exactly did I need to save? Certainly, what level the player was in. Also, the characteristics of the player character; finally, the choices the player had made so far in conversation.\nThese all seemed relatively simple to store in a file on the user’s system, and so I only had to choose an easy format to store the data in. For convenience’s sake, I chose JSON. </p>\n<p>I created a global file, called <strong>playervariables.gd</strong>, and used it to store all the data related to the player that I wanted to save between sessions. It ended up looking like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">\t\n<span class=\"token comment\">## This node is used to store variables that need to persist between multiple scenes. </span>\n<span class=\"token comment\">## It's effectively responsible for handling saved games.</span>\n\nvar currentScene<span class=\"token punctuation\">;</span> <span class=\"token comment\"># The scene the player was in at the time of saving.</span>\nvar playerHealth <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># The health of the player character.</span>\nvar kickedChest <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span> \nvar counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">## Global story events / artifacts</span>\n\nvar wifeComfort <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nvar wifeDread <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">## Node 00 Variables:</span>\n\nvar talkedToElders <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\nvar kidCutscenePlayed <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\nvar sawCutsceneInsideHome <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\nvar stayedWithWife<span class=\"token punctuation\">;</span>\n\nfunc save<span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token comment\">## Create the dictionary with the data we want to save.</span>\n\tvar save_dictionary <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token string\">\"fileName\"</span><span class=\"token punctuation\">:</span> fileName<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"filePath\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"user://savegame\"</span> <span class=\"token operator\">+</span> counter <span class=\"token keyword\">as</span> String <span class=\"token operator\">+</span> <span class=\"token string\">\".save\"</span><span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"currentScene\"</span><span class=\"token punctuation\">:</span> currentScene<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"kickedChest\"</span><span class=\"token punctuation\">:</span> kickedChest<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"playerHealth\"</span><span class=\"token punctuation\">:</span> playerHealth<span class=\"token punctuation\">,</span>\n\t\t\n\t\t<span class=\"token comment\">## Story / Scene Events Artifacts</span>\n\t\t\n\t\t<span class=\"token string\">\"wifeComfort\"</span><span class=\"token punctuation\">:</span> wifeComfort<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"wifeDread\"</span><span class=\"token punctuation\">:</span> wifeDread<span class=\"token punctuation\">,</span>\n\t\t\n\t\t<span class=\"token comment\">## Node00_Tutorial</span>\n\t\t\n\t\t<span class=\"token string\">\"talkedToElders\"</span><span class=\"token punctuation\">:</span> talkedToElders<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"kidCutscenePlayed\"</span><span class=\"token punctuation\">:</span> kidCutscenePlayed<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"sawCutsceneInsideHome\"</span><span class=\"token punctuation\">:</span> sawCutsceneInsideHome<span class=\"token punctuation\">,</span>\n\t\t<span class=\"token string\">\"stayedWithWife\"</span><span class=\"token punctuation\">:</span> stayedWithWife\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">## Write the data to a file.</span>\n\tvar saved_game <span class=\"token operator\">=</span> File<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> fileName<span class=\"token punctuation\">.</span>begins_with<span class=\"token punctuation\">(</span><span class=\"token string\">\"autosavegame\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t\tsaved_game<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user://autosavegame\"</span> <span class=\"token operator\">+</span> counter <span class=\"token keyword\">as</span> String<span class=\"token operator\">+</span> <span class=\"token string\">\".save\"</span><span class=\"token punctuation\">,</span> File<span class=\"token punctuation\">.</span>WRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsaved_game<span class=\"token punctuation\">.</span>store_line<span class=\"token punctuation\">(</span>to_json<span class=\"token punctuation\">(</span>save_dictionary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsaved_game<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n\t\tsaved_game<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user://\"</span> <span class=\"token operator\">+</span> fileName <span class=\"token operator\">+</span> <span class=\"token string\">\".save\"</span><span class=\"token punctuation\">,</span> File<span class=\"token punctuation\">.</span>WRITE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsaved_game<span class=\"token punctuation\">.</span>store_line<span class=\"token punctuation\">(</span>to_json<span class=\"token punctuation\">(</span>save_dictionary<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tsaved_game<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tcounter <span class=\"token operator\">=</span> counter <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>OS<span class=\"token punctuation\">.</span>get_user_data_dir<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># Debug line to navigate to the folder with file explorer.</span>\n\nfunc load<span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\tvar counter <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\tvar loaded <span class=\"token operator\">=</span> false<span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">## Try to open the saved game we selected. TODO Needs a way to handle failure.</span>\n\tvar saved_game <span class=\"token operator\">=</span> File<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tsaved_game<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>filePath<span class=\"token punctuation\">,</span> File<span class=\"token punctuation\">.</span>READ<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">## Load all the variables into this singleton.</span>\n\t<span class=\"token keyword\">while</span> <span class=\"token keyword\">not</span> loaded<span class=\"token punctuation\">:</span>\n\t\tvar currentLine <span class=\"token operator\">=</span> parse_json<span class=\"token punctuation\">(</span>saved_game<span class=\"token punctuation\">.</span>get_line<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tvar keys <span class=\"token operator\">=</span> currentLine<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\tvar values <span class=\"token operator\">=</span> currentLine<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\t\t<span class=\"token keyword\">for</span> key <span class=\"token keyword\">in</span> keys<span class=\"token punctuation\">:</span>\n\t\t\tplayer_variables<span class=\"token punctuation\">.</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">[</span>counter<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">[</span>counter<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tcounter <span class=\"token operator\">=</span> counter<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\t\tloaded <span class=\"token operator\">=</span> true<span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">## Data loaded successfully.</span>\n\tget_tree<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>change_scene<span class=\"token punctuation\">(</span>currentScene<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\nfunc saves_Exist<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t<span class=\"token comment\">## Navigate to the save file directory.</span>\n\tvar directory <span class=\"token operator\">=</span> Directory<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tvar userDir <span class=\"token operator\">=</span> directory<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user://\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">if</span> userDir <span class=\"token operator\">!=</span> OK<span class=\"token punctuation\">:</span> <span class=\"token comment\">## Something might be wrong with the directory.</span>\n\t\t<span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">## Now we check the files inside the directory.</span>\n\t<span class=\"token keyword\">elif</span> userDir <span class=\"token operator\">==</span> OK<span class=\"token punctuation\">:</span>\n\t\tvar files <span class=\"token operator\">=</span> directory<span class=\"token punctuation\">.</span>list_dir_begin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token comment\">## If there are no files, there are no save games.</span>\n\t\t<span class=\"token keyword\">if</span> files <span class=\"token operator\">!=</span> OK<span class=\"token punctuation\">:</span>\n\t\t\t<span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span>\n\t\t<span class=\"token comment\">## If there are files, look for files with the .save extension.</span>\n\t\t<span class=\"token keyword\">while</span> true<span class=\"token punctuation\">:</span>\n\t\t\tvar <span class=\"token builtin\">file</span> <span class=\"token operator\">=</span> directory<span class=\"token punctuation\">.</span>get_next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">.</span>ends_with<span class=\"token punctuation\">(</span><span class=\"token string\">\".save\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t\t\t\t<span class=\"token keyword\">return</span> true<span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">file</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">:</span>\n\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token comment\">## If there are no files with a .save extension, there are no saved games.</span>\n\t\tdirectory<span class=\"token punctuation\">.</span>list_dir_end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">return</span> false<span class=\"token punctuation\">;</span>\n\nfunc get_All_Saves<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\tvar files <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\">## Navigate to the save file directory.</span>\n\tvar directory <span class=\"token operator\">=</span> Directory<span class=\"token punctuation\">.</span>new<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tvar userDir <span class=\"token operator\">=</span> directory<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user://\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tvar dirFiles <span class=\"token operator\">=</span> directory<span class=\"token punctuation\">.</span>list_dir_begin<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token comment\"># If it's a save file, append it. Ignore hidden files.</span>\n\t<span class=\"token keyword\">while</span> true<span class=\"token punctuation\">:</span>\n\t\t\tvar <span class=\"token builtin\">file</span> <span class=\"token operator\">=</span> directory<span class=\"token punctuation\">.</span>get_next<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token builtin\">file</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">:</span>\n\t\t\t\t<span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token keyword\">elif</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">.</span>begins_with<span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span><span class=\"token operator\">&amp;</span> <span class=\"token builtin\">file</span><span class=\"token punctuation\">.</span>ends_with<span class=\"token punctuation\">(</span><span class=\"token string\">\".save\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\t\t\t\tfiles<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\tdirectory<span class=\"token punctuation\">.</span>list_dir_end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">return</span> files<span class=\"token punctuation\">;</span></code></pre></div>\n<p>By having the player variables stored here, I can easily access them from every scene when something happens that should change them. For instance, if you’re mean to your wife, I can do something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">playervariables<span class=\"token punctuation\">.</span>WifeComfort <span class=\"token operator\">=</span> playervariables<span class=\"token punctuation\">.</span>WifeComfort<span class=\"token operator\">-</span><span class=\"token number\">10</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>From any scene in the game. Then, when the player saves the game, that value will be saved onto a JSON file in the user directory; and when the player loads a game, I’ll simply parse the values back onto their respective variables, and load the player into the correct scene. All the dialogue and other aspects of the game will react appropriately, because all of their checks will be using the variables in <strong>playervariables.gd</strong> to verify a certain condition.</p>\n<p>The function <code class=\"language-text\">saves_exist()</code> needs to be there for UI purposes. When a player hits “Load Game”, I need to be able to tell if there’s any saved games available for me to show; if not, a different pop-up must indicate that. This function allows me to do that by checking for files with a .save extension, which I decided would be clear enough for the game’s save files, even though they’re glorified JSON files. This way I avoid any misunderstandings where an invalid JSON gets caught up in the listing of saved games available to load.</p>\n<p><code class=\"language-text\">get_all_saves</code> allows me to list the saved games in a UI for the player to choose from. Right now this UI is a simple Godot list showing all of the saved games, but it can easily turn into a full blown loading screen. If I wanted to, I could even save a screenshot of the viewport at the moment of saving, so that upon loading them I could show each saved game with a picture of the place they left the player in.</p>\n<h2>The downsides</h2>\n<p>There are two main downsides to this approach; one isn’t really a big deal, the other might be.</p>\n<p>The one that isn’t really a big deal is that saved games are easily manipulated. Since they’re just JSON files here, that means anyone can open them with a text editor and change the values; so if you wanted to trick the game into giving you 100 in WifeComfort or into thinking you talked to someone you didn’t, you could. I don’t really mind this, because this is meant to be a single player game; so if players want to manipulate their experience, let them. I’m not one to restrict what they want to do with the game - as long as the game I ship doesn’t break by default, players breaking it is something I’m perfectly fine with.</p>\n<p>The downside that might be a big deal is maintainability. With this approach, every event I want to keep track of needs to be a variable in the dictionary / file I’m saving. If the game grows big enough, this could be hell to manage. Imagine several different variables saying much the same thing: <code class=\"language-text\">talkedToFirstChest</code>, <code class=\"language-text\">talkedToSecondChest</code>, <code class=\"language-text\">wasMeanToThirdChest</code>, and so on. These would all have to be managed both there and throughout the code, which can be very complex.</p>\n<p>I have somewhat tried to mitigate this second downside by dividing the file clearly by node for easy navigation, but it is still a concern I have. Still, this implementation seems to solve the problem of saving and loading games well enough for now; so I’ll just have to think up an alternative if it ever becomes a problem. </p>\n<h2>Acknowledgement</h2>\n<p>Most of the assets you see in the proof of concept are free assets I’m using for mocking purposes, and they come from itch.io. You can find several free asset packs to work with there, although most of them require crediting if you end up using them in your end products.</p>\n<h2>What’s next?</h2>\n<p>Next month I’ll either write a new blog post on the implementation of another core system or, if I make any progress on the proof of concept for other gameplay loops, outline those, much like I did here for saving games. As usual, the development of the game has somewhat stagnated, as the book takes precedence this year.</p>\n<p>If you have any questions, comments or feedback, feel free to reach out to me through any of the channels I make available in the About page; and if you want to give a more in-depth look to the code, you can check my github, linked in the footer. Bear in mind all of this details my journey in self-teaching both Godot and game development, so I’m sure some of the ways I handle things are not optimal. It’s part of the learning process.</p>","frontmatter":{"title":"Dev Diaries #4: August Update - Implementing a Save Game System","date":"August 16, 2020","description":"An update on the state of the game as of August 2020, in the form of an implementation overview for saving and loading games."}}},"pageContext":{"slug":"/game-update-august-2020/","previous":{"fields":{"slug":"/book-update-july-2020/"},"frontmatter":{"title":"Book Update #3: Balance in the opening, and the problem with exposition"}},"next":{"fields":{"slug":"/book-update-august-2020/"},"frontmatter":{"title":"Book Update #4: Changes vs Improvements"}}}}}